- name: Play to install utils
  hosts: all

  vars:

    actionlint_version: v1.6.25  # rhysd/actionlint
    editor_config_checker_version: 2.7.0  # editorconfig-checker/editorconfig-checker
    fzf_version: 0.39.0  # junegunn/fzf
    gh_version: v2.33.0  # cli/cli
    iamlive_version: v0.51.2  # iann0036/iamlive
    shfmt_version: v3.7.0  # mvdan/sh
    terraform_ls_version: v0.31.5  # hashicorp/terraform-ls
    terraform_version: v1.5.5  # hashicorp/terraform
    tflint_version: v0.47.0  # terraform-linters/tflint
    tfsec_version: v1.28.1  # aquasecurity/tfsec
    trivy_version: v0.45.1  # aquasecurity/trivy

    zsh_completion_directory: "{{ target_directory }}/.config/zsh/completions.d"

  tasks:

    - name: Install Actionlint
      include_tasks: includes/zipped_executable.yml
      vars:
        product: actionlint
        url: https://github.com/rhysd/actionlint/releases/download/{{ actionlint_version }}/actionlint_{{ actionlint_version | trim('v') }}_{{ os }}_{{ architecture | default('amd64') }}.tar.gz
        version: "{{ actionlint_version | trim('v') }}"

    - name: Install Editor Config Checker
      include_tasks: includes/zipped_executable.yml
      vars:
        product: ec
        zipped_binary_path: bin/ec-{{ os }}-{{ architecture | default('amd64') }}
        url: https://github.com/editorconfig-checker/editorconfig-checker/releases/download/{{ editor_config_checker_version }}/ec-{{ os }}-{{ architecture | default('amd64') }}.tar.gz
        version: "{{ editor_config_checker_version }}"

    - name: Install fzf
      include_tasks: includes/zipped_executable.yml
      vars:
        product: fzf
        url: https://github.com/junegunn/fzf/releases/download/{{ fzf_version }}/fzf-{{ fzf_version }}-{{ os }}_{{ architecture | default('amd64') }}.{% if os == "darwin" %}zip{% else %}tar.gz{% endif %}
        version: "{{ fzf_version }}"

    - name: Install gh
      include_tasks: includes/zipped_executable.yml
      vars:
        product: gh
        zipped_binary_path: gh_{{ gh_version | trim('v') }}_{% if os == "darwin" %}macOS{% else %}linux{% endif %}_{{ architecture | default('amd64') }}/bin/gh
        url: https://github.com/cli/cli/releases/download/{{ gh_version }}/gh_{{ gh_version | trim('v') }}_{% if os == "darwin" %}macOS{% else %}linux{% endif %}_{{ architecture | default('amd64') }}.{% if os == "darwin" %}zip{% else %}tar.gz{% endif %}
        version: "{{ gh_version }}"

    - name: Install gh zsh completions
      shell: "{{ target_directory }}/.bin/gh completion -s zsh > {{ zsh_completion_directory }}/_gh"
      args:
        creates: "{{ zsh_completion_directory }}/_gh"

    - name: Install IAM live
      include_tasks: includes/zipped_executable.yml
      vars:
        product: iamlive
        url: https://github.com/iann0036/iamlive/releases/download/{{ iamlive_version }}/iamlive-{{ iamlive_version }}-{{ os }}-{{ architecture | default('amd64') }}.{% if os == "darwin" %}zip{% else %}tar.gz{% endif %}
        version: "{{ iamlive_version | trim('v') }}"

    - name: Install Terraform
      include_tasks: includes/zipped_executable.yml
      vars:
        product: terraform
        url: https://releases.hashicorp.com/terraform/{{ terraform_version | trim('v') }}/terraform_{{ terraform_version | trim('v') }}_{{ os }}_{{ architecture | default('amd64') }}.zip
        version: "{{ terraform_version | trim('v') }}"

    - name: Install Terraform LS
      include_tasks: includes/zipped_executable.yml
      vars:
        product: terraform-ls
        url: https://releases.hashicorp.com/terraform-ls/{{ terraform_ls_version | trim('v') }}/terraform-ls_{{ terraform_ls_version | trim('v') }}_{{ os }}_{{ architecture | default('amd64') }}.zip
        version: "{{ terraform_ls_version | trim('v') }}"

    - name: Install Tflint
      include_tasks: includes/zipped_executable.yml
      vars:
        product: tflint
        url: https://github.com/terraform-linters/tflint/releases/download/{{ tflint_version }}/tflint_{{ os }}_{{ architecture | default('amd64') }}.zip
        version: "{{ tflint_version | trim('v') }}"

    - name: Install Trivy
      include_tasks: includes/zipped_executable.yml
      vars:
        product: trivy
        url: https://github.com/aquasecurity/trivy/releases/download/{{ trivy_version }}/trivy_{{ trivy_version | trim('v') }}_{% if os == "darwin" %}macOS{% else %}linux{% endif %}-{{ architecture | default('64bit') }}.tar.gz
        version: "{{ trivy_version | trim('v') }}"

    # non-zipped utils

    - name: Get shfmt
      get_url:
        url: https://github.com/mvdan/sh/releases/download/{{ shfmt_version }}/shfmt_{{ shfmt_version }}_{{ os }}_{{ architecture | default('amd64') }}
        dest: "{{ target_directory }}/.bin/shfmt_{{ shfmt_version | trim('v') | regex_replace('\\.', '_') }}"
        mode: 0755
    - name: Link shfmt
      file:
        src: "{{ target_directory }}/.bin/shfmt_{{ shfmt_version | trim('v') | regex_replace('\\.', '_') }}"
        dest: "{{ target_directory }}/.bin/shfmt"
        state: link

    - name: Get tfsec
      get_url:
        url: https://github.com/aquasecurity/tfsec/releases/download/{{ tfsec_version }}/tfsec-{{ os }}-{{ architecture | default('amd64') }}
        dest: "{{ target_directory }}/.bin/tfsec_{{ tfsec_version | trim('v') | regex_replace('\\.', '_') }}"
        mode: 0755
    - name: Link tfsec
      file:
        src: "{{ target_directory }}/.bin/tfsec_{{ tfsec_version | trim('v') | regex_replace('\\.', '_') }}"
        dest: "{{ target_directory }}/.bin/tfsec"
        state: link
