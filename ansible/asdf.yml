- hosts: all

  vars:
    packages:
      - {plugin: nodejs, version: 16}
      - {plugin: python, version: 3.9}

  tasks:

    - name: Clone ASDF repository
      git:
        repo: https://github.com/asdf-vm/asdf.git
        dest: "{{ target_directory }}/.asdf/"
        version: v0.10.2

    - name: Install ASDF plugins
      shell: |
        source {{ target_directory }}/.asdf/asdf.sh
        asdf plugin-add {{ item }}
      args:
        creates: "{{ target_directory }}/.asdf/plugins/{{ item }}"
        executable: /bin/bash
      loop:
        - python
        - nodejs

    - name: Get latest package versions with ASDF
      shell: |
        set -o pipefail
        source {{ target_directory }}/.asdf/asdf.sh
        asdf latest {{ item.plugin }} {{ item.version }}
      args:
        executable: /bin/bash
      loop: "{{ packages }}"
      register: package_versions
      changed_when: false

    - name: Print latest package versions from ASDF
      debug:
        msg: Latest package version of {{ item.plugin }} is {{ package_versions.results[index].stdout }}
      loop: "{{ packages }}"
      loop_control:
        index_var: index

    - name: Install packages with ASDF
      shell: |
        source {{ target_directory }}/.asdf/asdf.sh
        asdf install {{ item.plugin }} {{ package_versions.results[index].stdout }}
        asdf global {{ item.plugin }} {{ package_versions.results[index].stdout }}
      args:
        creates: "{{ target_directory }}/.asdf/installs/{{ item.plugin }}/{{ package_versions.results[index].stdout }}"
        executable: /bin/bash
      loop: "{{ packages }}"
      loop_control:
        index_var: index
