- name: Play to install ASDF
  hosts: all

  vars:
    packages:
      - {plugin: nodejs, version: 20}
      - {plugin: python, version: 3.11}
      - {plugin: rust, version: 1.73, additional_option: https://github.com/asdf-community/asdf-rust.git}

  tasks:

    - name: Clone ASDF repository
      git:
        repo: https://github.com/asdf-vm/asdf
        dest: "{{ target_directory }}/.asdf/"
        version: v0.13.1  # asdf-vm/asdf

    - name: Install ASDF plugins
      shell: |
        source {{ target_directory }}/.asdf/asdf.sh
        asdf plugin-add {{ item.plugin }} {{ item.additional_option | default('') }}
      args:
        creates: "{{ target_directory }}/.asdf/plugins/{{ item.plugin }}"
        executable: /bin/bash
      loop: "{{ packages }}"

    - name: Get latest package versions with ASDF
      shell: |
        set -o pipefail
        source {{ target_directory }}/.asdf/asdf.sh
        asdf latest {{ item.plugin }} {{ item.version }}
      args:
        executable: /bin/bash
      loop: "{{ packages }}"
      register: package_versions
      changed_when: false

    - name: Print latest package versions from ASDF
      debug:
        msg: Latest package version of {{ item.plugin }} is {{ package_versions.results[index].stdout }}
      loop: "{{ packages }}"
      loop_control:
        index_var: index

    - name: Install packages with ASDF
      shell: |
        source {{ target_directory }}/.asdf/asdf.sh
        asdf install {{ item.plugin }} {{ package_versions.results[index].stdout }}
        asdf global {{ item.plugin }} {{ package_versions.results[index].stdout }}
      args:
        creates: "{{ target_directory }}/.asdf/installs/{{ item.plugin }}/{{ package_versions.results[index].stdout }}"
        executable: /bin/bash
      loop: "{{ packages }}"
      loop_control:
        index_var: index

    # this is created when installing packages, but the nodejs install is brand new
    - name: Create node_modules directory
      file:
        path: "{{ target_directory }}/.asdf/installs/nodejs/{{ package_versions.results[0].stdout }}/.npm/lib/node_modules"
        state: directory
        mode: 0755

    # see https://nodejs.org/api/modules.html#modules_loading_from_the_global_folders
    - name: Create ~/.node_modules link
      file:
        src: "{{ target_directory }}/.asdf/installs/nodejs/{{ package_versions.results[0].stdout }}/.npm/lib/node_modules"
        dest: "{{ target_directory }}/.node_modules"
        state: link
